<!DOCTYPE html>
<html lang="en">
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title>使用 nvprof 来检测 CUDA 程序运行效率 | Cayman</title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1671.5">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px Times; color: #000000; -webkit-text-stroke: #000000}
    span.s1 {font-kerning: none}
  </style>
</head>
<body>
<p class="p1"><span class="s1"><meta name="generator" content="Hugo 0.55.6" />    <script type="text/javascript" async src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style><span class="Apple-converted-space"> </span></span></p>
</body>
</html>

<body>
  <section class="page-header">
  <h1 class="project-name">
    Cayman Hugo Theme
  </h1>
  <h2 class="project-tagline">
    A clean, responsive Hugo theme, ported from the original Jekyll Cayman theme
  </h2>
  <nav>
    
    
      
      
      
      
      <a href="/" class="btn">Blog</a>
    
      
      
      
      
      <a href="/tags/" class="btn">Tags</a>
    
      
      
      
      
      <a href="/about/" class="btn">About</a>
    
      
      
      
      
      <a href="/index.xml" class="btn">RSS</a>
    
  </nav>
</section>

  <section class="main-content">
    
  <h1>使用 nvprof 来检测 CUDA 程序运行效率</h1>
  <p>nvprof 是 CUDA Toolkit 自带的 CUDA 程序运行效率分析工具。它可以生成 kernel 函数和 CUDA API 运行时间报表，肥肠好用！有了它你再也不用调系统的时间函数把代码搞得乱七八糟的了。下面请看示例。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#bc7a00">#include</span> <span style="color:#bc7a00">&lt;stdio.h&gt;</span><span style="color:#bc7a00">
</span><span style="color:#bc7a00">#include</span> <span style="color:#bc7a00">&lt;curand_kernel.h&gt;</span><span style="color:#bc7a00">
</span><span style="color:#bc7a00"></span>__global__ <span style="color:#b00040">void</span> <span style="color:#00f">hello</span>()
{
    printf(<span style="color:#ba2121">&#34;Hello CUDA!</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span>);
}
<span style="color:#b00040">int</span> <span style="color:#00f">main</span>()
{
    cudaFree(<span style="color:#666">0</span>);
    hello<span style="color:#666">&lt;&lt;&lt;</span><span style="color:#666">1</span>,<span style="color:#666">10</span><span style="color:#666">&gt;&gt;&gt;</span>();
    cudaDeviceReset();
    <span style="color:#008000;font-weight:bold">return</span> <span style="color:#666">0</span>;
}
</code></pre></div>
<p>我们编译然后使用 nvprof 运行可以得到如下结果：</p>

<p><img src="https://github.com/zkyue/Picturefloor/raw/master/cuda_hello.png" alt="cuda_hello" /></p>

<p>nvprof 会别类分门统计出一个详尽的结果，这里面需要注意的点有：</p>

<ul>
<li>nvprof 在 Nvidia Driver 418 以后的版本中使用受到限制，报错为&rdquo;Waining：The user does not have permission to profile on the target device.&ldquo;，我按照<a href="https://developer.nvidia.com/nvidia-development-tools-solutions-ERR_NVGPUCTRPERM-permission-issue-performance-counters">官网的操作</a>不 work，最后在<a href="https://zhuanlan.zhihu.com/p/62128896">知乎</a>找到的解决方案，备份如下：</li>
</ul>

<p><img src="https://github.com/zkyue/Picturefloor/raw/master/nvprof_permission.jpg" alt="nvprof_permission" /></p>

<ul>
<li>CUDA 启动和释放运行环境都需要时间，这个会算在程序调用的 CUDA API 的第一个和最后一个头上，如果你调用的第一个函数是 cudaMalloc() 你可能会觉得内存分配怎么会这么慢！我这里用 <code>cudaFree(0)</code>和 <code>cudaDeviceReset()</code> 来为这两个时间背锅,可以看到它们的耗时都在几十上百毫秒的级别。</li>
<li>如果你需要在 kernel 函数中打印输出，直接调用 kernel 函数是没有效果的，可以在程序末尾调用<code>cudaDeviceReset()</code>或<code>cudaDeviceSynchronize()</code>来达到设备同步。</li>
</ul>


    <footer class="site-footer">
  <span class="site-footer-credits">
    Made with <a href="https://gohugo.io/">Hugo</a>. Themed by <a href="https://github.com/zwbetz-gh/cayman-hugo-theme">Cayman</a>. Deployed to <a href="https://www.netlify.com/">Netlify</a>.
  </span>
</footer>

  </section>
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

</body>
</html>
